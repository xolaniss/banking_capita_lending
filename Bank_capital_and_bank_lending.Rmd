---
output:
  bookdown::pdf_document2:
    citation_package: natbib
    fig_caption: yes
    latex_engine: xelatex
    number_sections: yes
    toc: no
    keep_tex: true
    includes:
      in_header: preamble.tex
      before_body: title.tex
      # after_body: appendix_backcover.tex
  bookdown::word_document2:
    fig_width: 3 
    fig_height: 3
    reference_docx: new_template_no_numbering.docx
# title: "A Pandoc Markdown Article Starter and Template"
# thanks: "Replication files are available on the author's Github account..."
# author:
# date: "`r format(Sys.time(), '%B %d, %Y')`"
# abstract:
#  "This document provides an introduction to R Markdown, argues for its...  \\par \\textbf{Keywords:} one, two, three " 
# fontfamily: mathpazo
# fontsize: 12
# spacing: double
# documentclass: article
# classoption: fleqn
# paper: a4
csl: ucl-institute-of-education-harvard.csl
bibliography: references.bib
biblio-style: sarb.bst
natbiboptions: round
# link-citations: no
# linkcolor: blue!000!black
# urlcolor: blue!000!black
# citecolor: blue!000!black
# linestretch: 1.5
# indent: TRUE
---

```{r setup, include=FALSE}
options(scipen=999)
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      dpi = 500, 
                      fig.pos = "H", 
                      fig.align = "left", 
                      fig.env= 'figure', 
                      fig.height = 8,
                      tab.topcaption = FALSE,
                      ft.align = "left")
options(xtable.floating = TRUE,
        xtable.caption.placement = 'top', # notice \floatsetup overrides
        xtable.include.rownames = FALSE,
        xtable.comment = FALSE,
        xtable.booktabs = TRUE,
        xtable.table.placement = "H",
        xtable.tabular.environment = "tabularx",
        xtable.NA.string = "NA", 
        xtable.width = "\\textwidth", 
        xtable.size = "\\tiny", 
        xtable.hline.after = c(-1,0)
        )

```

```{r loading_packages, echo=FALSE}
library(tidyverse)
library(readr)
library(readxl)
library(zoo)
library(magick)
library(stringi)
library(patchwork)
library(xtable)
library(scales)
library(rvest)
library(rebus)
library(PNWColors)
library(lubridate)
library(here)
library(flextable)
library(gt)
library(officer)
library(modelsummary)

theme <-
  theme_minimal(base_size = 6) +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none",) # EU base theme
theme_set(theme) # setting ggplot theme instead of using theme function
```

```{r funcs, echo=FALSE}
multi_line_plot <- function(data, plotname = "",
                            variables_color = 3, 
                            legend_position = "top"
                            )  {
  data %>% 
  ggplot(aes(x = Date, y = Value)) +
  geom_line(aes(color = Series, linetype = Series), size = 1) +
  theme_bw() +
    theme(
      legend.position = legend_position,
      legend.title = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(colour = "black"),
      panel.border = element_blank(),
      text = element_text(size = 8),
      strip.background = element_rect(colour = "white", fill = "white"),
      axis.text.x = element_text(angle = 90),
      axis.title = element_text(size = 7),
      plot.tag = element_text(size = 8)
    ) +
    labs(x = "", y = plotname) +
    scale_color_manual(values = pnw_palette("Cascades", variables_color)) 
}

```



# Introduction
The paper investigates the impact of Basel III regulation on bank lending in South Africa. This introduction is an overview of the paper

# Context
A review of policy context, with focus on South Africa but also reference to other emerging markets. Further detail in Appendix 1 and 2a.

# Literature

@osborne2017good

@jokipii2008cyclical

@gambacorta2004does

@schwert2018bank

@kim2017effect

@carlson2013capital

@tabak2011bank

@altunbas2004bank

@gambacorta2018bank

@berrospide2010effects

\newpage
# Developments in South African Banking



```{r}
#| fig.cap = "Credit Cycle. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = TRUE,
#| fig.height = 3
general <- read_rds(here("Outputs", "artifacts_general.rds"))

credit_cyle_gg <- 
  general$data$credit_cycle_tbl %>% 
  mutate(value = value/100) %>% 
  ggplot(aes(x = Date, y = value, linetype = Cycles)) +
  geom_rect( 
           fill = "grey", 
           alpha = .01,
           aes(xmin = as.Date(c("2008-01-01")), 
           xmax = as.Date(c("2009-10-01")),
           ymin = -Inf,
           ymax = Inf)) +
  geom_rect( 
           fill = "grey", 
           alpha = .01,
           aes(xmin = as.Date(c("2014-01-01")), 
           xmax = as.Date(c("2020-04-01")),
           ymin = -Inf,
           ymax = Inf)) +
  geom_line(aes(color = Cycles), size = 1) +
  scale_x_date(date_labels = ("%Y")) +
  labs(x = "", y = "year on year percentage change" , caption = "Shaded area represent downward phases of the business cycle.") +
  theme_bw() +
    theme(
      legend.position = "top",
      legend.title = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(colour = "black"),
      panel.border = element_blank(),
      text = element_text(size = 8),
      strip.background = element_rect(colour = "white", fill = "white"),
      axis.text.x = element_text(angle = 90),
      axis.title = element_text(size = 7),
      plot.tag = element_text(size = 8)
    ) +
    labs(x = "", y = "") +
    scale_color_manual(values = pnw_palette("Cascades", 2)) +
    scale_y_continuous(labels = scales::label_percent()) 
  
credit_cyle_gg
```


```{r}
#| fig.cap = "Capital Buffers. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = TRUE,
#| fig.height = 3

car_gg <- general$data$car_tbl %>% 
  pivot_longer(-Date, names_to = "Series", values_to = "Value") %>% 
  mutate(Series = factor(Series, levels = c("Total capital adequacy ratio", "Minimum requirement", "Surplus capital"))) %>% 
  mutate(Value = Value /100) %>% 
  multi_line_plot(legend_position = "none") +
  scale_y_continuous(labels = scales::label_percent()) +
  facet_wrap(~ Series) 
  
car_gg
```



```{r}
#| cache = FALSE,
#| include = FALSE,
#| fig.height = 3


BA_900_quarterly <- read_rds(here("Outputs", "artifacts_balance_sheet_quartely.rds"))
BA_900_quarterly_combined_gg <- 
  BA_900_quarterly$quarterly_data$Totals_quarter_tbl %>% 
  multi_line_plot(variables_color = 6, legend_position = "none") +
     scale_y_continuous(labels = scales::label_dollar(prefix =  "R", 
                                                       scale_cut = cut_short_scale())) +
  facet_wrap(~ Series, scales = "free_y") +
  labs(subtitle = "Bank assets in Rand" )
  

```



```{r}
#| cache = FALSE,
#| include = FALSE,
#| fig.height = 3

BA_900_to_GDP <-  read_rds(here("Outputs", "artifacts_balance_sheet_gdp.rds"))
BA_900_to_GDP_combined_gg <- BA_900_to_GDP$data$total_gdp_tbl %>% 
  multi_line_plot(variables_color = 6, legend_position = "none") +
     scale_y_continuous(labels = scales::label_percent()) +
  facet_wrap(~ Series, scales = "free_y") +
  labs(subtitle = "Bank assets as a percentage of GDP" )



```

```{r}
#| fig.cap = "Bank assets. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = TRUE,
#| fig.height = 6

BA_900_quarterly_combined_gg  / BA_900_to_GDP_combined_gg 

```


```{r}
#| fig.cap = "Lending Rates. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = TRUE,
#| fig.height = 6
lending_rate_cleanup <- function(data, bank = "Total Banks"){
  data %>% 
    mutate(Description = str_c(Banks, " ", Description)) %>% 
    dplyr::select(-Banks, -Item, -`Outstanding balance at month`) %>% 
    rename(
      "Series" = "Description",
      "Value" = "Weighted average rate (%)") %>% 
    drop_na() %>% 
    filter(str_detect(Series, bank)) %>% 
    mutate(Value = Value/100) %>% 
    mutate(Series = str_to_sentence(Series)) %>% 
    mutate(Series = str_remove_all(Series, "\"")) %>% 
    mutate(Series = str_replace_all(Series, ":", "-")) %>% 
    mutate(Series = str_replace_all(Series, "- -", "-")) %>% 
    mutate(`Item Description` = str_replace_all(`Item Description`, "leasing transactions", "")) %>% 
    mutate(`Item Description` = str_replace_all(`Item Description`, "installment sale agreements", "")) %>% 
    mutate(`Item Description` = str_replace_all(`Item Description`, " mortgage advances", "")) %>% 
    mutate(`Item Description` = str_replace_all(`Item Description`, "corporate sector ", "corporate sector")) %>%
    mutate(`Item Description` = str_replace_all(`Item Description`, "household sector " , "household sector" )) %>% 
    mutate(`Item Description` = str_replace_all(`Item Description`, "domestic private sector " , "Domestic private sector" )) %>% 
    mutate(`Series` = str_replace_all(`Series`, "-corporate sector", "")) %>% 
    mutate(`Series` = str_replace_all(`Series`, "-household sector", "")) %>% 
    mutate(`Series` = str_replace_all(`Series`, "-domestic private sector", ""))
}

lending_rates <- read_rds(here("Outputs", "artifacts_lending_rates_v2.rds"))

lending_rates_cleaned_tbl <- 
  lending_rates$data$lending_rate_tbl %>% 
  lending_rate_cleanup() %>% 
  filter(!`Item Description` %in% c("Micro loans", "Interbank lending rate", "foreign sector" )) %>% 
  mutate(`Item Description` = str_to_sentence(`Item Description`)) %>% 
  mutate(`Series` = str_replace_all(`Series`, "Total banks credit cards-" , "Total banks credit cards")) %>% 
  mutate(`Series` = str_replace_all(`Series`, "Total banks - fixed rate installment sale agreements" , "Total banks installment sale agreements- fixed rate")) %>% 
  mutate(`Series` = str_replace_all(`Series`, "Total banks - fixed rate leasing transactions" , "Total banks leasing transactions- fixed rate")) %>% 
  mutate(`Series` = str_replace_all(`Series`, "Total banks - fixed rate mortgage advances" , "Total banks mortgage advances- fixed rate" )) %>% 
  mutate(`Series` = str_replace_all(`Series`, "Total banks " , "" )) %>% 
  mutate(Series = str_to_sentence(Series))

# unique(lending_rates_cleaned_tbl$`Item Description`)   
# unique(lending_rates_cleaned_tbl$Series)  

lending_rates_cleaned_tbl %>% 
  ggplot(aes(x = Date, y = Value)) +
  geom_line(aes(color = `Item Description`, linetype = `Item Description`), size = 1) +
  theme_bw() +
    theme(
      legend.position = "top",
      legend.title = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(colour = "black"),
      panel.border = element_blank(),
      text = element_text(size = 8),
      strip.background = element_rect(colour = "white", fill = "white"),
      axis.text.x = element_text(angle = 90),
      axis.title = element_text(size = 7),
      plot.tag = element_text(size = 8)
    ) +
    labs(x = "", y = "") +
    scale_color_manual(values = pnw_palette("Cascades", 3)) +
    scale_y_continuous(labels = scales::label_percent()) +
    facet_wrap( ~ Series , scales = "free")
  
  
```

# Specification


# Estimation Results

# Conclusion

\newpage
# Appendix: Descriptive Analysis

## Data

### Capital Buffers

```{r}
#| capbuf,
#| fig.cap = "Capital buffers. Source: South African Reserve Bank (2022) REMOVE",
#| cache = FALSE,
#| include = FALSE

capital_buffers <- read_rds(here("Outputs", "artifacts_capital_buffers.rds"))

capital_buffers$graphs$big_banks_gg  #delete from the final draft

```

### BA 900 Quartelty Data

```{r}
#| ba900totals,
#| fig.cap = "Bank lending totals. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

ba900 <- read_rds(here("Outputs", "artifacts_balance_sheet_quartely.rds"))
ba900$quartely_graphs$Total_quartely_gg
```


```{r, include=FALSE}
#| ba900absa,
#| fig.cap = "Absa bank lending. Source: South African Reserve Bank (2022) ",
#| cache = FALSE,
#| include = FALSE

ba900$quartely_graphs$absa_quartely_gg
```


```{r, include=FALSE}
#| ba900fnb,
#| fig.cap = "FNB bank lending. Source: South African Reserve Bank (2022) ",
#| cache = FALSE,
#| include = FALSE

ba900$quartely_graphs$fnb_quartely_gg
```


```{r}
#| ba900nedbank,
#| fig.cap = "Nedbank bank lending. Source: South African Reserve Bank (2022) ",
#| cache = FALSE,
#| include = FALSE

ba900$quartely_graphs$nedbank_quartely_gg
```

```{r}
#| ba900standard,
#| fig.cap = "Standard bank lending. Source: South African Reserve Bank (2022) ",
#| cache = FALSE,
#| include = FALSE

ba900$quartely_graphs$standard_quartely_gg
```

```{r}
#| ba900capitec,
#| fig.cap = "Capitec bank lending. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

ba900$quartely_graphs$capitec_quartely_gg
```


### BA 900 to GDP

```{r}
#| nominal,
#| fig.cap = "Nominal GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| fig.height = 3,
#| include = FALSE

balance_sheet_gdp <- read_rds(here("Outputs", "artifacts_balance_sheet_gdp.rds"))
balance_sheet_gdp$graphs$nominal_GDP_gg
```


```{r}
#| ba900gdptotals,
#| fig.cap = "Total bank lending as a percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$total_gdp_gg
```


```{r}
#| ba900gdpfnb,
#| fig.cap = "FNB lending as a percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$fnb_gdp_gg
```

```{r}
#| ba900gdpabsa,
#| fig.cap = "Absa lending as a percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$absa_gdp_gg
```

```{r}
#| ba900gdpstandard,
#| fig.cap = "Standard bank lending as percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$standard_gdp_gg
```

```{r}
#| ba900gdpnedbank,
#| fig.cap = "Nedbank lending as percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$nedbank_gdp_gg
```

```{r, include=FALSE}
#| ba900gdpcapitec,
#| fig.cap = "Capitec lending as percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$capitec_gdp_gg
```

\newpage
# Appendix: Detailed Literature Review

More detailed literature review

\newpage
# References
