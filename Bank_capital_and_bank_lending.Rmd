---
output:
  bookdown::pdf_document2:
    citation_package: natbib
    fig_caption: yes
    latex_engine: xelatex
    number_sections: yes
    toc: no
    keep_tex: true
    includes:
      in_header: preamble.tex
      before_body: title.tex
      # after_body: appendix_backcover.tex
  bookdown::word_document2:
    fig_width: 3 
    fig_height: 3
    reference_docx: new_template_no_numbering.docx
# title: "A Pandoc Markdown Article Starter and Template"
# thanks: "Replication files are available on the author's Github account..."
# author:
# date: "`r format(Sys.time(), '%B %d, %Y')`"
# abstract:
#  "This document provides an introduction to R Markdown, argues for its...  \\par \\textbf{Keywords:} one, two, three " 
# fontfamily: mathpazo
# fontsize: 12
# spacing: double
# documentclass: article
# classoption: fleqn
# paper: a4
csl: ucl-institute-of-education-harvard.csl
bibliography: references.bib
biblio-style: sarb.bst
natbiboptions: round
# link-citations: no
# linkcolor: blue!000!black
# urlcolor: blue!000!black
# citecolor: blue!000!black
# linestretch: 1.5
# indent: TRUE
---

```{r setup, include=FALSE}
options(scipen=999)
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      dpi = 500, 
                      fig.pos = "H", 
                      fig.align = "left", 
                      fig.env= 'figure', 
                      fig.height = 8,
                      tab.topcaption = FALSE,
                      ft.align = "left",
                      ft.arraystretch = 0.6)


```

```{r loading_packages, echo=FALSE}
library(tidyverse)
library(readr)
library(readxl)
library(zoo)
library(magick)
library(stringi)
library(patchwork)
library(xtable)
library(scales)
library(rvest)
library(rebus)
library(PNWColors)
library(lubridate)
library(here)
library(flextable)
library(gt)
library(officer)
library(modelsummary)

theme <-
  theme_minimal(base_size = 6) +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none",) # EU base theme
theme_set(theme) # setting ggplot theme instead of using theme function
```

```{r funcs, echo=FALSE}
multi_line_plot <- function(data, plotname = "",
                            variables_color = 3, 
                            legend_position = "top"
                            )  {
  data %>% 
  ggplot(aes(x = Date, y = Value)) +
  geom_line(aes(color = Series, linetype = Series), size = 1) +
  theme_bw() +
    theme(
      legend.position = legend_position,
      legend.title = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(colour = "black"),
      panel.border = element_blank(),
      text = element_text(size = 8),
      strip.background = element_rect(colour = "white", fill = "white"),
      axis.text.x = element_text(angle = 90),
      axis.title = element_text(size = 7),
      plot.tag = element_text(size = 7)
    ) +
    labs(x = "", y = plotname) +
    scale_color_manual(values = pnw_palette("Cascades", variables_color)) 
}

source(here("Functions", "flextable_word.R"))

set_flextable_defaults(
  font.size = 7
)
```

# Introduction

The paper investigates the impact of Basel III regulation on bank lending in South Africa. This introduction is an overview of the paper

# Context

A review of policy context, with focus on South Africa but also reference to other emerging markets. Further detail in Appendix 1 and 2a.

# Literature

@osborne2017good

@jokipii2008cyclical

@gambacorta2004does

@schwert2018bank

@kim2017effect

@carlson2013capital

@tabak2011bank

@altunbas2004bank

@gambacorta2018bank

@berrospide2010effects

\newpage

# Developments in South African Banking

```{r}
#| fig.cap = "Internatinal Comparison. Source: World Bank (2022)",
#| cache = FALSE,
#| include = TRUE,
#| fig.height = 3

preprocessing <-  read_rds(here("Outputs", "artifacts_preprocessing.rds"))


internation_comp <- read_rds(here("Outputs", "artifacts_int_comp.rds"))
internation_comp$graph$int_comp_average_gg


```

```{r}
#| fig.cap = "Credit Cycle. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = TRUE,
#| fig.height = 3
general <- read_rds(here("Outputs", "artifacts_general.rds"))

credit_cyle_gg <- 
  general$data$credit_cycle_tbl %>% 
  mutate(value = value/100) %>% 
  ggplot(aes(x = Date, y = value, linetype = Cycles)) +
  geom_rect( 
           fill = "grey", 
           alpha = .01,
           aes(xmin = as.Date(c("2008-01-01")), 
           xmax = as.Date(c("2009-10-01")),
           ymin = -Inf,
           ymax = Inf)) +
  geom_rect( 
           fill = "grey", 
           alpha = .01,
           aes(xmin = as.Date(c("2014-01-01")), 
           xmax = as.Date(c("2020-04-01")),
           ymin = -Inf,
           ymax = Inf)) +
  geom_line(aes(color = Cycles), size = 1) +
  scale_x_date(date_labels = ("%Y")) +
  labs(x = "", y = "year on year percentage change" , caption = "Shaded area represent downward phases of the business cycle.") +
  theme_bw() +
    theme(
      legend.position = "top",
      legend.title = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(colour = "black"),
      panel.border = element_blank(),
      text = element_text(size = 8),
      strip.background = element_rect(colour = "white", fill = "white"),
      axis.text.x = element_text(angle = 90),
      axis.title = element_text(size = 7),
      plot.tag = element_text(size = 8)
    ) +
    labs(x = "", y = "") +
    scale_color_manual(values = pnw_palette("Cascades", 2)) +
    scale_y_continuous(labels = scales::label_percent()) 
  
credit_cyle_gg
```

```{r}
#| fig.cap = "Capital Buffers. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = TRUE,
#| fig.height = 3

car_gg <- general$data$car_tbl %>% 
  pivot_longer(-Date, names_to = "Series", values_to = "Value") %>% 
  mutate(Series = factor(Series, levels = c("Total capital adequacy ratio", "Minimum requirement", "Surplus capital"))) %>% 
  mutate(Value = Value /100) %>% 
  multi_line_plot(legend_position = "none") +
  scale_y_continuous(labels = scales::label_percent()) +
  facet_wrap(~ Series) 
  
car_gg
```

```{r}
#| cache = FALSE,
#| include = FALSE,
#| fig.height = 3


BA_900_quarterly_tbl <- preprocessing$Totals$combined_level_data_tbl
BA_900_quarterly_combined_gg <- 
  BA_900_quarterly_tbl %>% 
  pivot_longer(-Date, values_to = "Value", names_to = "Series") %>% 
  multi_line_plot(variables_color = 7, legend_position = "none") +
     scale_y_continuous(labels = scales::label_dollar(prefix =  "R", 
                                                       scale_cut = cut_short_scale())) +
  facet_wrap(~ Series, scales = "free_y") +
  labs(subtitle = "Bank assets in Rand" )
  

```

```{r}
#| cache = FALSE,
#| include = FALSE,
#| fig.height = 3

BA_900_to_GDP_tbl <- preprocessing$Totals$combined_gdp_ratio_data_tbl 
  
BA_900_to_GDP_combined_gg <- BA_900_to_GDP_tbl %>% 
   mutate(across(.cols = -Date, .fns = ~.x/100)) %>% 
   pivot_longer(-Date, values_to = "Value", names_to = "Series") %>% 
  multi_line_plot(variables_color = 7, legend_position = "none") +
     scale_y_continuous(labels = scales::label_percent()) +
  facet_wrap(~ Series, scales = "free_y") +
  labs(subtitle = "Bank assets as a percentage of GDP" )



```

```{r}
#| fig.cap = "Bank assets. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = TRUE,
#| fig.height = 6

BA_900_quarterly_combined_gg  / BA_900_to_GDP_combined_gg 

```

```{r}
#| fig.cap = "Lending Rates. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = TRUE,
#| fig.height = 4

lending_rates_cleaned_tbl <- preprocessing$Totals$combined_lending_tbl

lending_rates_cleaned_tbl %>% 
  mutate(across(.cols = -Date, .fns = ~.x/100)) %>% 
  pivot_longer(-Date, values_to = "Value", names_to = "Series") %>% 
   multi_line_plot(variables_color = 7, legend_position = "none") +
     scale_y_continuous(labels = scales::label_percent()) +
  facet_wrap(~ Series, scales = "free_y")
  
  
  
  
```

\newpage

# Specification


# Estimation Results

```{r}

#| cache = FALSE,
#| include = TRUE,

preprocessing$masters$total_master_tbl %>% 
  mutate(across(.cols = 2:8, .fns = ~.x/1000000000)) %>% 
  pivot_longer(-Date, names_to = "Series", values_to = "Value") %>% 
  mutate(Groups = case_when(
    str_detect(Series, "GDP") ~ "Total Assets/GDP (%)",
    str_detect(Series, "rate$") ~ "Lending Rates (%)",
    str_detect(Series, "Surplus|Minimum") ~ "Regulatory Capital (%)",
    TRUE ~ "Total Assets (R Billions)"
  )) %>% 
  drop_na() %>% 
  group_by(Groups, Series) %>% 
  summarise(across(.cols = -c(Date),
                   .fns = list(Median = median, 
                               SD = sd,
                               Min = min,
                               Obs = ~ n()), 
                   .names = "{.fn}")) %>% 
  as_grouped_data(groups = "Groups") %>% 
  flextable_word(
  caption = "Descriptives",
  ) %>%
  align(align = "left", part = "all") %>%
  autofit() %>% 
  set_header_labels(
    Groups = " ",
    Series = " "
  )


```

# Conclusion

\newpage

# Appendix

## Data Sources

```{r}
#| data,
#| cache = FALSE,
#| include = TRUE

tibble(
  " " = c("BA900", 
          "BA930", 
          "Controls",
          "GDP",
          "Capital buffer",
          "Credit cycle",
          "Country comparison"
          ),
  "Description" = c("Banking sector balance sheet data at a bank level",
                    "Banking sector lending rates at a bank level",
                    "Banking sector performance data at a bank level",
                    "Nominal and real gross domestic product
in a calendar year",
                    "Basel III regulatory capital buffer requirement",
                    "Composite index of lending conditions in South Africa",
                    "International data on:
domestic credit to private sector (% of GDP), 
bank return on assets (%, before tax), 
bank capital to total assets (%), 
and bank concentration (%)
                    "
                    ),
  "Frequency" = c("Monthly",
                  "Monthly",
                  "Monthly",
                  "Quarterly",
                  "Monthly",
                  "Monthly",
                  "Yearly"
                  ),
  
  "Availability" = c("Public data",
                     "Aggregated data is public. 
Bank specific data is private",
                     "Aggregated data is public. 
Bank specific data is private",
                     "Public data",
                     "Aggregated data is public. 
Bank specific data is private",
                     "Public data",
                      "Public data"
                     ),
  "Source" = c("SARB",
               "SARB",
               "PA",
               "PA",
               "Statssa",
               "SARB",
               "World Bank"
               )
) %>% 
  flextable_word(caption = "Data Description") %>%
  align(align = "left", part = "all") %>%
  autofit(add_w = 0)



```

\newpage
## Aggregation schema

The following tabulation is derived from the BA900s is the balance sheet return loan data (lines 103 to 277) and  gives relative magnitudes by financial corporate sector, non-financial corporate sector and household sector. This is the most granular data provided. The missing item numbers are all aggregations of these numbers.

```{r}
#| scheme,
#| fig.cap = "BA900s schema",
#| cache = FALSE,
#| include = TRUE,

tibble(
  "BA 900 Categories" = 
    c(
      "Installment sales",
      "",
      "",
      "",
      "Leasing transactions",
      "",
      "",
      "",
      "Farm Mortgages",
      "",
      "",
      "Residential Mortgages",
      "",
      "",
      "Commercial and Other mortgages",
      "",
      "",
      "",
      "",
      "",
      "Credit cards",
      "",
      "",
      "",
      "Overdrafts",
      "",
      "",
      "",
      "",
      "",
      "Factoring"
    ),
  "Item Number" = c(
    141,
    142,
    143,
    144,
    146,
    147,
    148,
    149,
    152,
    153,
    154,
    156,
    157,
    158,
    160,
    161,
    162,
    163,
    164,
    165,
    167,
    168,
    169,
    170,
    172-179,
    181,
    182,
    183,
    184,
    185,
    187
  ),
  "Sector" = c(
    "Financial corporate sector",
    "Non financial corporate sector",
    "Household sector",
    "Other",
    "Financial corporate sector",
    "Non financial corporate sector",
    "Household sector",
    "Other",
    "Non financial corporate sector",
    "Household sector",
    "Other",
    "Non financial corporate sector",
    "Household sector",
    "Other",
    "Public financial corporates",
    "Public non-financial corporates",
    "Private financial corporate",
    "Private non-financial corporates",
    "Household sector",
    "Other",
    "Financial corporate sector",
    "Non financial corporate sector",
    "Household sector",
    "Other",
    "Public sector (includes public corporations and local government)",
    "Financial corporate sector",
    "Non financial corporate sector",
    "Unincorporated business enterprises",
    "Other Household sector",
    "Non-profit organisations serving households",
    ""
  ),
  "Aggregation Key" = c(
    "-",
    "a",
    "c",
    "a",
    "-",
    "a",
    "c",
    "a",
    "b",
    "b",
    "b",
    "b",
    "d",
    "b",
    "-",
    "-",
    "-",
    "b",
    "b",
    "b",
    "-",
    "a",
    "c",
    "c",
    "-",
    "-",
    "a",
    "e",
    "c",
    "c",
    "a"
  ),
) %>% 
  flextable_word(caption = "Aggregation schema") %>% 
  align(align = "left", part = "all") %>%
  colformat_num(digits = 0, j = 2) %>% 
  autofit(add_w = -0.05)


```

The following aggregation scheme which results in six categories was followed based on Table \@ref(tab:scheme), with unincorporated enterprise credit as part of household unsecured lending.

a.	Non-financial corporate sector secured credit: Items 142 + 147 
b.	Non-financial corporate sector unsecured credit: Items 168 + 182 + 187+ 190
c.	Non-financial corporate sector mortgages (commercial and other mortgage advances): Items 152 + 153 + 154 + 156 + 158 + 163 + 164 + 165
d.	Household sector secured credit: Items 143 + 148  
e.	Household sector unsecured credit: Items 169 + 184 + 185 +  192 + 193 + 183 + 191 (note includes unincorporated business enterprise credit last two items)
f.	Household sector residential mortgages: Item 157

\newpage
The loans quantities from the BA900s are then linked to the lending rate data from the BA930s using table to create six lending rate categories the schema on Table \@ref(tab:schemelend).

```{r}
#| schemelend,
#| cache = FALSE,
#| include = TRUE,

tibble(
  "Sector" = c(
   "Corporate sector",
   "",
   "",
   "",
   "",
   "",
   "",
   "",
   "",
   "Household sector",
   "",
   "",
   "",
   "",
   "",
   "",
   "",
   ""
  ),
  "BA 930 Categories" = c(
    "Overdrafts",
    "Instalment sale agreements flexible rate",
    "Instalment sale fixed rate",
    "Leasing transactions flexible rate",
    "Leasing transactions fixed rate",
    "Mortgage advances flexible rate",
    "Mortgage advances fixed rate",
    "Credit cards",
    "Other",
    "Overdrafts",
    "Instalment sale agreements flexible rate",
    "Instalment sale fixed rate",
    "Leasing transactions flexible rate",
    "Leasing transactions fixed rate",
    "Mortgage advances flexible rate",
    "Mortgage advances fixed rate",
    "Credit cards",
    "Other"
  ),
  "Item Number" = c(
    48,
    49,
    50,
    51,
    52,
    53,
    54,
    55,
    56,
    58,
    59,
    60,
    61,
    62,
    63,
    64,
    65,
    66
  ),
  "Weighting Key" = c(
    "b",
    "a",
    "-",
    "a",
    "-",
    "c",
    "-",
    "b",
    "b",
    "e",
    "d",
    "-",
    "d",
    "-",
    "f",
    "-",
    "e",
    "e"
  )
) %>% 
  flextable_word(caption = "Weighting schema") %>% 
  align(align = "left", part = "all") %>%
  colformat_num(digits = 0, j = 2) %>% 
  autofit(add_w = .5)




```

The six categories, therefore, are as follows:

a. Non-financial corporate sector secured credit rate: Weighted average of items 49 + 51
b. Non-financial corporate sector unsecured credit rate: Weighted average items 48 + 55 + 56
c. Non-financial corporate sector mortgage rate: Item 53
d. Household sector secured credit rate: Weighted average of items 59 + 61
e. Household sector unsecured credit rate: Weighted average of items 58 + 65 + 66
f. Household sector residential mortgages: Item 63

\newpage
# Appendix: Descriptive Analysis


<!-- ## Data -->

<!-- ### Capital Buffers -->

```{r}
#| capbuf,
#| fig.cap = "Capital buffers. Source: South African Reserve Bank (2022) REMOVE",
#| cache = FALSE,
#| include = FALSE

capital_buffers <- read_rds(here("Outputs", "artifacts_capital_buffers.rds"))

capital_buffers$graphs$big_banks_gg  #delete from the final draft

```

<!-- ### BA 900 Quartelty Data -->

```{r}
#| ba900totals,
#| fig.cap = "Bank lending totals. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

ba900 <- read_rds(here("Outputs", "artifacts_balance_sheet_quartely.rds"))
ba900$quartely_graphs$Total_quartely_gg
```

```{r, include=FALSE}
#| ba900absa,
#| fig.cap = "Absa bank lending. Source: South African Reserve Bank (2022) ",
#| cache = FALSE,
#| include = FALSE

ba900$quartely_graphs$absa_quartely_gg
```

```{r, include=FALSE}
#| ba900fnb,
#| fig.cap = "FNB bank lending. Source: South African Reserve Bank (2022) ",
#| cache = FALSE,
#| include = FALSE

ba900$quartely_graphs$fnb_quartely_gg
```

```{r}
#| ba900nedbank,
#| fig.cap = "Nedbank bank lending. Source: South African Reserve Bank (2022) ",
#| cache = FALSE,
#| include = FALSE

ba900$quartely_graphs$nedbank_quartely_gg
```

```{r}
#| ba900standard,
#| fig.cap = "Standard bank lending. Source: South African Reserve Bank (2022) ",
#| cache = FALSE,
#| include = FALSE

ba900$quartely_graphs$standard_quartely_gg
```

```{r}
#| ba900capitec,
#| fig.cap = "Capitec bank lending. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

ba900$quartely_graphs$capitec_quartely_gg
```

<!-- ### BA 900 to GDP -->

```{r}
#| nominal,
#| fig.cap = "Nominal GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| fig.height = 3,
#| include = FALSE

balance_sheet_gdp <- read_rds(here("Outputs", "artifacts_balance_sheet_gdp.rds"))
balance_sheet_gdp$graphs$nominal_GDP_gg
```

```{r}
#| ba900gdptotals,
#| fig.cap = "Total bank lending as a percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$total_gdp_gg
```

```{r}
#| ba900gdpfnb,
#| fig.cap = "FNB lending as a percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$fnb_gdp_gg
```

```{r}
#| ba900gdpabsa,
#| fig.cap = "Absa lending as a percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$absa_gdp_gg
```

```{r}
#| ba900gdpstandard,
#| fig.cap = "Standard bank lending as percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$standard_gdp_gg
```

```{r}
#| ba900gdpnedbank,
#| fig.cap = "Nedbank lending as percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$nedbank_gdp_gg
```

```{r, include=FALSE}
#| ba900gdpcapitec,
#| fig.cap = "Capitec lending as percent of GDP. Source: South African Reserve Bank (2022)",
#| cache = FALSE,
#| include = FALSE

balance_sheet_gdp$graphs$capitec_gdp_gg
```

\newpage

\newpage
# Appendix: Detailed Literature Review

More detailed literature review

\newpage

# References
